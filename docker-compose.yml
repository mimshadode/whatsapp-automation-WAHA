version: '3.8'

services:
  # Database Layer
  postgres:
    image: postgres:15-alpine
    container_name: whatsapp_postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgrespw
      POSTGRES_DB: whatsapp_automation
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Cache Layer
  redis:
    image: redis:7-alpine
    container_name: whatsapp_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # WhatsApp API Layer
  waha:
    image: devlikeapro/waha:chrome
    container_name: whatsapp_waha
    restart: always
    ports:
      - "5000:3000"
    environment:
      # Configurations from previous successful setup
      - WAHA_API_KEY=75b08331d7774ee5850f711f9b2c7206
      - WAHA_DASHBOARD_USERNAME=admin
      - WAHA_DASHBOARD_PASSWORD=ca79f123edc24db2829e6c823e522d1d
      - WHATSAPP_SWAGGER_USERNAME=admin
      - WHATSAPP_SWAGGER_PASSWORD=ca79f123edc24db2829e6c823e522d1d
      - WHATSAPP_DEFAULT_ENGINE=NOWEB
      - WHATSAPP_NOWEB_STORE_ENABLED=true
      - WHATSAPP_NOWEB_STORE_FULL_SYNC=true
      - WHATSAPP_HOOK_URL=http://host.docker.internal:3001/api/webhook
      - WHATSAPP_HOOK_EVENTS=message,session.status
      # Media Storage Configuration
      - WHATSAPP_DOWNLOAD_MEDIA=true
      - WHATSAPP_FILES_FOLDER=/app/.media
      - WHATSAPP_FILES_LIFETIME=0
    volumes:
      - waha_data:/app/.wwebjs_auth
      - waha_media:/app/.media

volumes:
  postgres_data:
  redis_data:
  waha_data:
  waha_media:
